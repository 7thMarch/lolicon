<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setu Viewer</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3.5.1/dist/vue.global.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- TypeScript -->
    <script src="https://unpkg.com/typescript@5.3.3/lib/typescript.js"></script>
    <!-- Axios for HTTP requests -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app">
        <div class="container mx-auto px-4 py-8">
            <!-- Header -->
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800 mb-2">Setu Viewer</h1>
                <p class="text-gray-600">Explore Pixiv Artworks</p>
            </header>

            <!-- Main Content -->
            <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="md:flex">
                    <!-- Image Section -->
                    <div class="md:flex-1 p-4">
                        <div class="relative aspect-square bg-gray-100 rounded-lg overflow-hidden">
                            <img 
                                :src="currentImage" 
                                @error="handleImageError"
                                class="w-full h-full object-contain"
                                :class="{'animate-pulse': loading}"
                            />
                            <div v-if="loading" class="absolute inset-0 flex items-center justify-center">
                                <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Info Section -->
                    <div class="md:w-80 p-6 bg-gray-50">
                        <div class="space-y-4">
                            <div>
                                <h2 class="text-sm font-semibold text-gray-500">PID</h2>
                                <a 
                                    :href="'https://www.pixiv.net/artworks/' + artworkData.pid"
                                    class="text-blue-600 hover:text-blue-800 hover:underline"
                                    target="_blank"
                                >
                                    {{ artworkData.pid || 'Loading...' }}
                                </a>
                            </div>
                            <div>
                                <h2 class="text-sm font-semibold text-gray-500">Title</h2>
                                <p class="text-gray-800">{{ artworkData.title || 'Loading...' }}</p>
                            </div>
                            <div>
                                <h2 class="text-sm font-semibold text-gray-500">Author</h2>
                                <p class="text-gray-800">{{ artworkData.author || 'Loading...' }}</p>
                            </div>
                            <div>
                                <h2 class="text-sm font-semibold text-gray-500">Tags</h2>
                                <div class="flex flex-wrap gap-2 mt-1">
                                    <span 
                                        v-for="tag in parsedTags" 
                                        :key="tag"
                                        class="inline-block px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full"
                                    >
                                        {{ tag }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Button -->
            <div class="text-center mt-8">
                <button 
                    @click="getRandomImage"
                    class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 disabled:opacity-50"
                    :disabled="loading"
                >
                    Next Image
                </button>
            </div>

        </div>
    </div>

    <script>
        // TypeScript interface definitions
        interface ArtworkData {
            pid: string;
            title: string;
            author: string;
            tags: string;
            url: string;
        }

        // Vue app
        const { createApp, ref, computed } = Vue;

        createApp({
            setup() {
                const indexData = ref<string[]>([]);
                const artworkData = ref<ArtworkData>({
                    pid: '',
                    title: '',
                    author: '',
                    tags: '',
                    url: ''
                });
                const loading = ref(true);
                const currentImage = ref('./images/loading.svg');

                const reverseProxyPrefixs = [
                    "https://pixiv.ciallo.link",
                    "https://pixiv.mayx.eu.org",
                    "https://i.yuki.sh",


                ]

                const randomReverseProxyPrefix = reverseProxyPrefixs[Math.floor(Math.random() * reverseProxyPrefixs.length)];

                const parsedTags = computed(() => {
                    return artworkData.value.tags ? artworkData.value.tags.split(',').map(tag => tag.trim()) : [];
                });

                async function fetchIndexData() {
                    try {
                        const response = await axios.get('/lolicon/index.json');
                        indexData.value = response.data;
                                      console.log("Index data fetched: ", JSON.stringify(indexData.value, null, 2));
                        await getRandomImage();
                    } catch (error) {
                        console.error('Error fetching index data:', error);
                    }
                }

                async function getRandomImage() {
                    if (!indexData.value.length || loading.value) return;

                    loading.value = true;
                    currentImage.value = './images/loading.svg';

                    try {
                        const randomIndex = Math.floor(Math.random() * indexData.value.length);
                        const response = await axios.get(`/lolicon/data/${indexData.value[randomIndex]}`);
                        artworkData.value = response.data;
                        console.log("Artwork data fetched: ", JSON.stringify(artworkData.value.url, null, 2));
                        currentImage.value = `${randomReverseProxyPrefix}${response.data.url}`;
                    } catch (error) {
                        console.error('Error fetching image data:', error);
                    }
                }

                function handleImageError() {
                    loading.value = false;
                    currentImage.value = './images/loading.svg';
                }

                // Initialize
                fetchIndexData();

                return {
                    artworkData,
                    loading,
                    currentImage,
                    parsedTags,
                    getRandomImage,
                    handleImageError
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
